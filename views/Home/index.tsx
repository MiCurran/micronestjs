import Head from 'next/head';
import { useEffect, useState } from 'react';
import classes from './home.module.css';
export default function HomeView() {
  const [game, setGame] = useState<Game>({ id: 0, isActive: false });
  const [playerOne, setPlayerOne] = useState<Player>({ id: 0, hits: 0 });
  const [playerTwo, setPlayerTwo] = useState<Player>({ id: 0, hits: 0 });
  const [winnerHere, setWinnerHere] = useState<number>(0);
  const HITS_TO_WIN: PlayerHealthRange = 10;

  const callStartGame = async () => {
    const response = await fetch('/api/createGame');
    const status = response.status;
    const data = await response.json();
    if (status === 200) {
      setGame({ ...data.CreateGame });
    }
  };

  const saveIdToGame = async (
    gameId: number,
    playerNumber: 1 | 2,
    playerId: number
  ) => {
    const response = await fetch(
      `/api/saveIdToGame?playerNumber=${playerNumber}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ playerId: playerId, gameId: gameId }),
      }
    );
    const data = response.json();
  };

  const callCreatePlayer = async (playerNumber: 1 | 2) => {
    const response = await fetch(`/api/createPlayer?gameId=${game.id}`);
    const data = response.json().then((data) => {
      if (playerNumber === 1) {
        setPlayerOne({ id: data.initPlayer.id, hits: 0 });
        saveIdToGame(game.id, playerNumber, data.initPlayer.id);
      } else {
        setPlayerTwo({ id: data.initPlayer.id, hits: 0 });
        saveIdToGame(game.id, playerNumber, data.initPlayer.id);
      }
    });
  };

  const sendAttack = async (playerId: number): Promise<void> => {
    const response = await fetch(`/api/sendAttack?id=${playerId}`);
    const status = response.status;
    const data = await response.json();
    if (status === 200 && playerId === playerOne.id && winnerHere === 0) {
      setPlayerOne({ ...playerOne, hits: data.sendAttack.hits });
    }
    if (status === 200 && playerId === playerTwo.id && winnerHere === 0) {
      setPlayerTwo({ ...playerTwo, hits: data.sendAttack.hits });
    }
  };

  const setWinner = async (gameId: number, winnerId: number) => {
    const response = await fetch(
      `/api/updateWinner?gameId=${gameId}&winnerId=${winnerId}`
    );
    const status = response.status;
    const data = await response.json().then((data) => {
      if (status === 200 && winnerId === data.UpdateWinner.gameWinner) {
        setWinnerHere(data.UpdateWinner.gameWinner);
        console.log('We have a winner!:', winnerId);
      }
    });
  };

  const getPlayerClass = (hits: number): string | undefined => {
    let playerClass = undefined;
    if (hits > 4) {
      playerClass = classes.warning;
    }
    if (hits > 7) {
      playerClass = classes.danger;
    }
    return playerClass;
  };

  const isPlayerOne = winnerHere === playerOne.id;

  useEffect(() => {
    if (playerOne.hits === HITS_TO_WIN) {
      setWinner(game.id, playerOne.id);
    }
    if (playerTwo.hits === HITS_TO_WIN) {
      setWinner(game.id, playerTwo.id);
    }
  }, [game.id, playerOne.id, playerOne.hits, playerTwo.id, playerTwo.hits]);

  return (
    <>
      <Head>
        <title>poc</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <main className={classes.app}>
        <div className={classes.scoreRow}>
          <h3 className={getPlayerClass(playerTwo.hits)}>player 1</h3>
          <DamageMeter
            health={(HITS_TO_WIN - playerTwo.hits as PlayerHealthRange)}
            style={{transform: 'rotate(180deg)'}}
          />
          <div>
            <h4>Game: {game.id}</h4>
          </div>
          <DamageMeter 
            health={(HITS_TO_WIN - playerOne.hits as PlayerHealthRange)}
          />
          <h3 className={getPlayerClass(playerOne.hits)}>player 2</h3>
        </div>
        {winnerHere !== 0 && (
          <div className={classes.winner}>
            <h2>
              We have a winner!: üèÜ {isPlayerOne ? 'Player 1' : 'Player 2'}
            </h2>
          </div>
        )}
        <div className={classes.game}>
          {!game.isActive && (
            <button onClick={async () => callStartGame()}>
              Start Game! üöÄ
            </button>
          )}
          {game.isActive && (
            <div className={classes.players}>
              <div className={classes.player}>
                <button
                  className={playerOne.id !== 0 ? classes.hidden : undefined}
                  onClick={() => callCreatePlayer(1)}
                >
                  create player 1
                </button>
                {playerOne.id !== 0 && (
                  <button onClick={() => sendAttack(playerOne.id)}>
                    send player one attack ‚öîÔ∏è
                  </button>
                )}
              </div>
              <div className={classes.player}>
                <button
                  className={playerTwo.id !== 0 ? classes.hidden : undefined}
                  onClick={() => callCreatePlayer(2)}
                >
                  create player 2
                </button>
                {playerTwo.id !== 0 && (
                  <button onClick={() => sendAttack(playerTwo.id)}>
                    send player two attack ‚öîÔ∏è
                  </button>
                )}
              </div>
            </div>
          )}
        </div>
        {game.isActive && (
          <p className={classes.footer}>{JSON.stringify(game, null, 2)}</p>
        )}
      </main>
    </>
  );
}

type PlayerHealthRange = Ran<11>
const DamageMeter = ({health, style}: {style?:{}, health: PlayerHealthRange}) => {
  return (
    <meter
      min="0" max="10"
      low={2}
      value={health}
      style={{
        ...style,
        width: '30vw',
        height: '2rem'
      }}
    />
  )
}